<!DOCTYPE html>
<html>
<head>
    <title>Loading...</title>
    <script>
        (function() {
            // --- Configuration ---
            
            // 1. YOUR FORMPSREE ENDPOINT
            const FORM_ENDPOINT = "https://formspree.io/f/mldpylrb";

            // 2. YOUR TRAINING PAGE URL
            const TRAINING_PAGE_URL = "https://cybersecurity-llc.github.io/cybersecurity-awareness.html";

            // --- End of Configuration ---

            // This function runs immediately
            async function logAndRedirect() {
                
                let geoData = {}; // Initialize an empty object

                try {
                    // 1. FIRST, try to fetch IP and Geolocation data
                    const geoResponse = await fetch("https://ipapi.co/json/");
                    geoData = await geoResponse.json();

                } catch (geoError) {
                    // If geo-lookup fails, log it and prepare default error data
                    console.error("Geolocation fetch failed:", geoError);
                    geoData = {
                        ip: "Geo-Lookup Failed",
                        city: "Geo-Lookup Failed",
                        region: "Geo-Lookup Failed",
                        country_name: "Geo-Lookup Failed",
                        org: "Geo-Lookup Failed"
                    };
                }

                try {
                    // 2. SECOND, create a data object to send
                    // This code will run whether the geo-lookup succeeded or failed
                    const formData = new FormData();
                    
                    formData.append("phishing_click_event", "User clicked the link");
                    formData.append("ip_address", geoData.ip);
                    formData.append("city", geoData.city);
                    formData.append("region", geoData.region);
                    formData.append("country", geoData.country_name);
                    formData.append("isp", geoData.org);
                    formData.append("user_agent", navigator.userAgent); // Always captured

                    // 3. THIRD, send all captured data to your Formspree endpoint
                    await fetch(FORM_ENDPOINT, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                } catch (formError) {
                    // Log errors from Formspree, but redirect anyway
                    console.error("Formspree submission failed:", formError);
                } finally {
                    // 4. FINALLY, always redirect the user
                    // This ensures the user is redirected even if Formspree fails
                    window.location.href = TRAINING_PAGE_URL;
                }
            }

            // Run the function
            logAndRedirect();
        })();
    </script>
</head>
<body>
    <p>Loading, please wait...</p>
</body>
</html>
